# ウェブページ更新監視ツール

## 概要
このツールは指定したウェブページの更新を監視し、変更があった場合にメールで通知するアプリケーションです。GitHub Actionsを使用して定期的に実行され、更新の検出から通知までを自動化します。

> このREADMEは部分的に生成AIによって作成されています．

## リポジトリ構成
```
├── .github/
│   └── workflows/
│       └── main.yml    # GitHub Actionsの設定ファイル
├── html_snapshots/     # HTMLスナップショット保存用ディレクトリ
│       └── .gitkeep     
├── main.py             # メインのPythonスクリプト
├── requirements.txt    # Pythonの依存パッケージ
├── urls.txt            # 監視対象のURLリスト
├── last_hashes.json    # 前回のページ内容のハッシュ値
└── README.md           # このファイル
```

## 技術仕様
- プログラミング言語: Python 3.9
- 主要ライブラリ:
  - requests: ウェブページの取得
  - beautifulsoup4: HTMLの解析
  - python-dotenv: 環境変数の管理
  - difflib: HTML差分の抽出
  - smtplib: メール送信
  - email.mime: メールメッセージの作成
  - hashlib: ハッシュ値の生成
  - json: ハッシュ値の保存と読み込み
  - os: ファイル操作
  - openai: OpenAI APIによる差分要約

## 機能説明
### 主要関数
1. `initialize_hash_file()`
   - ハッシュファイルの初期化
   - ファイルが存在しない場合に空のJSONオブジェクトを作成
   - エラーハンドリングを含む

2. `load_hashes()`
   - 前回のハッシュ値を読み込み
   - ファイルが存在しない場合や不正な形式の場合は空の辞書を返す
   - JSONデコードエラーのハンドリング

3. `save_hashes(hashes)`
   - 新しいハッシュ値を保存
   - JSON形式でファイルに書き込み
   - インデント付きで整形して保存

4. `generate_hash(content)`
   - ページの内容からMD5ハッシュを生成
   - 更新の検出に使用
   - テキストのエンコーディング処理を含む

5. `load_urls()`
   - 監視対象のURLを読み込み
   - urls.txtからURLリストを取得
   - 空行の除外とトリミング処理
   - エラーハンドリングを含む

6. `get_page_content(url)`
   - 指定したURLのページ内容を取得
   - HTTPステータスコードの確認
   - エラーハンドリングを含む
   - 詳細なログ出力

7. `save_html(url, content)`
   - ウェブページのHTMLを保存
   - UTF-8エンコーディングで保存
   - ファイルパスの自動生成
   - 詳細なエラーハンドリングとログ出力

8. `load_previous_html(url)`
   - 前回保存したHTMLを読み込み
   - UTF-8エンコーディングで読み込み
   - ファイルの存在確認
   - 詳細なエラーハンドリングとログ出力

9. `delete_html(url)`
   - 指定したURLのHTMLスナップショットを削除
   - ファイルの存在確認
   - エラーハンドリングを含む
   - ログ出力

10. `get_diff(previous_content, current_content)`
    - 前回と現在のHTMLの差分を抽出
    - 統一形式（unified diff）で差分を表示
    - 初回監視時の特別処理
    - 行単位での差分抽出

11. `send_email(url, changes)`
    - 更新通知のメールを送信
    - SMTPサーバーを使用（TLS暗号化）
    - 複数のメールアドレスに対応
    - エラーハンドリングを含む
    - 詳細なログ出力

12. `check_webpage_changes()`
    - メインの監視処理
    - 各URLの内容を取得し、前回のハッシュと比較
    - URLの追加・削除を検出
    - 更新を検出した場合にメール通知
    - 変更のサマリーを表示
    - 詳細なログ出力

13. `summarize_diff_with_openai(diff, url)`
    - OpenAI APIを使用して差分を要約
    - 差分が長すぎる場合は自動的に切り詰め
    - APIキーが設定されていない場合は差分をそのまま返す
    - 認証エラー、レート制限、クレジット不足等のエラーハンドリング
    - AI要約と詳細差分の両方を通知に含める

## 監視の種類
1. ページの更新
   - ページの内容が変更された場合に通知
   - ハッシュ値の比較により検出
   - HTMLの差分を抽出して通知
   - 変更箇所の詳細な表示
   - OpenAI APIを使用して差分を要約し、理解しやすい形で通知

2. URLの追加
   - 新しいURLが追加された場合に通知
   - 初回の監視開始を通知
   - 変更サマリーに表示
   - HTMLスナップショットの自動保存

3. URLの削除
   - URLが削除された場合に検出
   - 変更サマリーに表示
   - HTMLスナップショットの自動削除
   - 次回から監視対象から除外

## ローカルでの実行方法
1. 環境の準備
   ```bash
   pip install -r requirements.txt
   ```

2. 環境変数の設定
   `.env`ファイルを作成し、以下を設定：
   ```
   SMTP_SERVER=smtp.gmail.com
   SMTP_PORT=587
   EMAIL_USER=your_email@gmail.com
   EMAIL_PASSWORD=your_app_password
   TO_EMAILS=user1@example.com,user2@example.com,user3@example.com
   OPENAI_API_KEY=your_openai_api_key
   ```

3. 監視対象URLの設定
   `urls.txt`に監視したいURLを1行ずつ記述

4. HTMLスナップショットディレクトリの準備
   ```bash
   mkdir html_snapshots
   ```

5. 実行
   ```bash
   python main.py
   ```

## GitHub Actionsでの実行方法
1. リポジトリの設定
   - リポジトリの「Settings」→「Secrets and variables」→「Actions」で以下を設定：
     - SMTP_SERVER
     - SMTP_PORT
     - EMAIL_USER
     - EMAIL_PASSWORD
     - TO_EMAILS（カンマ区切りのメールアドレスリスト）
     - OPENAI_API_KEY（OpenAI APIキー）

2. ワークフローの設定
   - デフォルトで毎日午前10時（日本時間）に実行
   - 手動実行も可能
   - HTMLスナップショットのキャッシュとコミットを自動管理

3. 実行の確認
   - 「Actions」タブでワークフローの実行状況を確認
   - ログでエラーや通知の送信状況を確認
   - URLの変更状況を確認
   - HTMLスナップショットの更新を確認

## 注意事項
- Gmailを使用する場合は2段階認証を有効にし、アプリパスワードを生成する必要があります
- 監視対象のURLが変更された場合、初回実行時に通知が送信されます
- 複数のメールアドレスはカンマ（,）で区切って指定します
- URLの追加・削除は実行時に自動的に検出されます
- HTMLスナップショットは`html_snapshots`ディレクトリに保存され、GitHubリポジトリで管理されます
- 差分抽出はHTMLの行単位で行われ、変更箇所が明確に表示されます
- GitHub Actionsのスケジュール実行では、設定時刻から最大数時間のズレが発生する可能性があります
- エラーハンドリングが詳細に実装されており、問題発生時には詳細なログが出力されます
- ファイル操作はすべてUTF-8エンコーディングで行われます
- **OpenAI API機能**: APIキーが設定されていない場合や、クレジット不足、レート制限等のエラーが発生した場合は、従来通り差分をそのまま通知します
- **AI要約**: 差分が長すぎる場合は自動的に切り詰めてから要約を行います

## 更新履歴
### Apr. 29, 2025
- 初回公開

### May 1, 2025
- HTML保存機能を追加
  - 監視対象ページのHTMLスナップショットを保存
  - 差分検出時に前回のHTMLと比較可能
  - `html_snapshots`ディレクトリに自動保存
  - 差分抽出機能を追加
  - GitHub Actionsでの自動管理機能を追加
  - 監視対象URLが削除された場合にHTMLスナップショットを自動削除

### May 30, 2025
- HTMLの更新時に明示的に古いファイルを削除する処理を追加

### Jun. 4, 2025
- 技術解説を更新（挙動に関する注意書きを追加）

### Jun. 9, 2025
- ワークフローファイルを更新しました
  - 各実行で固有のidを利用することで過去のキャッシュを読み込んでしまうバグを解消しました

### Jun. 10, 2025
- ワークフローファイルからキャッシュに関する部分を削除しました
   - ハッシュ値の管理やHTMLスナップショットの管理をGithubリポジトリに統一することでエラーを解消しました

### Jun. 24, 2025
- パッケージのバージョンについて更新を行い，セキュリティの問題を解消しました

### Dec. 19, 2025
- OpenAI APIによる差分要約機能を追加
  - ウェブページの更新時にOpenAI APIを使用して差分を要約
  - 要約と詳細差分の両方を通知に含める
  - APIキーが設定されていない場合やエラーが発生した場合は従来通り差分をそのまま通知
  - 差分が長すぎる場合は自動的に切り詰めてから要約
  - エラーハンドリングを強化（認証エラー、レート制限、クレジット不足等）
